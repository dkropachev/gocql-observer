version: "3.9"

services:
  scylla-cluster1:
    image: ${SCYLLA_IMAGE}
    command:
      - "--cluster-name"
      - "cluster1"
      - "--seeds"
      - "scylla-cluster1"
      - "--smp"
      - "2"
      - "--memory"
      - "512M"
      - "--overprovisioned"
      - "1"
    ports:
      - "9042:9042"
    healthcheck:
      test: [ "CMD", "cqlsh", "-e", "select * from system.local WHERE key='local'" ]
      interval: 5s
      timeout: 5s
      retries: 60

  scylla-cluster2:
    image: ${SCYLLA_IMAGE}
    command:
      - "--cluster-name"
      - "cluster2"
      - "--seeds"
      - "scylla-cluster2"
      - "--smp"
      - "2"
      - "--memory"
      - "512M"
      - "--overprovisioned"
      - "1"
    ports:
      - "9142:9042"
    healthcheck:
      test: [ "CMD", "cqlsh", "-e", "select * from system.local WHERE key='local'" ]
      interval: 5s
      timeout: 5s
      retries: 60

  gocql-observer:
    build:
      context: ..
    depends_on:
      scylla-cluster1:
        condition: service_healthy
      scylla-cluster2:
        condition: service_healthy
    environment:
      CLUSTER1_CONTACT_POINTS: scylla-cluster1
      CLUSTER2_CONTACT_POINTS: scylla-cluster2
      LOG_DIRECTORY: /observer/logs
      RUN_DURATION: 1m
    volumes:
      - ../logs:/observer/logs
    healthcheck:
      test:
        - "CMD-SHELL"
        - "test -f /observer/logs/cluster1.log && test -f /observer/logs/cluster2.log"
      interval: 10s
      timeout: 5s
      retries: 6
